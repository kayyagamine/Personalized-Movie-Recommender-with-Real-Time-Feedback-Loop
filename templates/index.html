<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMatch - Movie Recommender</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-film"></i> Recommendo</h1>
            <p>Discover your next favorite movie with our intelligent recommendation system</p>
            {% if stats %}
            <div class="stats-bar">
                <div class="stat-item">
                    <i class="fas fa-video"></i>
                    <span>{{ stats.total_movies }} Movies</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-masks"></i>
                    <span>{{ stats.unique_genres }} Genres</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-language"></i>
                    <span>{{ stats.unique_languages }} Languages</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-star"></i>
                    <span>Avg Rating: {{ "%.1f"|format(stats.avg_rating) }}</span>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Search Form -->
        <form method="POST" class="search-form">
            <div class="form-grid">
                <!-- Enhanced Genre Selector -->
                <div class="input-group genre-input-group">
                    <label for="genre"><i class="fas fa-masks"></i> Genre Selection</label>
                    <div class="genre-selector">
                        <div class="genre-tabs">
                            <button type="button" class="genre-tab active" data-mode="all">
                                <i class="fas fa-globe"></i> All Genres
                            </button>
                            <button type="button" class="genre-tab" data-mode="select">
                                <i class="fas fa-filter"></i> Custom Selection
                            </button>
                        </div>
                        <div class="genre-options" id="genreOptions" style="display: none;">
                            <div class="genre-search">
                                <input type="text" id="genreSearch" placeholder="Search genres..." class="genre-search-input">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="genre-grid-container">
                                <div class="genre-grid">
                                    {% for genre in available_genres %}
                                    {% if genre != 'All' %}
                                    <label class="genre-checkbox" data-genre="{{ genre.lower() }}">
                                        <input type="checkbox" name="genres" value="{{ genre }}" 
                                               {% if selected_genres and genre in selected_genres %}checked{% endif %}>
                                        <span class="checkmark">
                                            <span class="genre-name">{{ genre }}</span>
                                            {% if genre_counts and genre in genre_counts %}
                                            <small class="count">({{ genre_counts[genre] }})</small>
                                            {% endif %}
                                        </span>
                                    </label>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="genre-actions">
                                <button type="button" class="select-all-btn">
                                    <i class="fas fa-check-double"></i> Select All
                                </button>
                                <button type="button" class="clear-selection-btn">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                            </div>
                        </div>
                        <input type="hidden" name="genre" id="selectedGenres" value="{% if selected_genres %}{{ selected_genres|join(',') }}{% endif %}">
                    </div>
                </div>
                
                <!-- Enhanced Language Selector -->
                <div class="input-group language-input-group">
                    <label for="language"><i class="fas fa-language"></i> Language Preference</label>
                    <div class="custom-select-wrapper">
                        <select id="language" name="language" class="custom-select">
                            {% for lang in available_languages %}
                            <option value="{% if lang == 'All' %}{% else %}{{ lang }}{% endif %}" 
                                    data-count="{% if language_counts and lang != 'All' and lang in language_counts %}{{ language_counts[lang] }}{% endif %}"
                                    {% if selected_language == lang or (lang == 'All' and not selected_language) %}selected{% endif %}>
                                {{ lang }}
                                {% if language_counts and lang != 'All' and lang in language_counts %}
                                - {{ language_counts[lang] }} movies
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="select-arrow">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="language-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Choose your preferred movie language</span>
                    </div>
                </div>

                <div class="input-group">
                    <label for="min_rating"><i class="fas fa-star"></i> Minimum Rating</label>
                    <div class="rating-input">
                        <input type="number" id="min_rating" step="0.1" name="min_rating" 
                               min="0" max="10" value="{{ min_rating or 5 }}" placeholder="5.0">
                        <div class="rating-range">
                            {% if stats %}
                            <small>Range: {{ "%.1f"|format(stats.rating_range[0]) }} - {{ "%.1f"|format(stats.rating_range[1]) }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Enhanced Results Count Selector -->
                <div class="input-group results-input-group">
                    <label for="max_results"><i class="fas fa-list-ol"></i> Results to Show</label>
                    <div class="results-selector">
                        <div class="result-options">
                            <input type="radio" id="result_10" name="max_results" value="10" 
                                   {% if max_results == 10 or not max_results %}checked{% endif %}>
                            <label for="result_10" class="result-option">
                                <span class="number">10</span>
                                <span class="label">Quick</span>
                            </label>

                            <input type="radio" id="result_20" name="max_results" value="20" 
                                   {% if max_results == 20 %}checked{% endif %}>
                            <label for="result_20" class="result-option">
                                <span class="number">20</span>
                                <span class="label">Standard</span>
                            </label>

                            <input type="radio" id="result_50" name="max_results" value="50" 
                                   {% if max_results == 50 %}checked{% endif %}>
                            <label for="result_50" class="result-option">
                                <span class="number">50</span>
                                <span class="label">Extended</span>
                            </label>

                            <input type="radio" id="result_100" name="max_results" value="100" 
                                   {% if max_results == 100 %}checked{% endif %}>
                            <label for="result_100" class="result-option">
                                <span class="number">100</span>
                                <span class="label">Max</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <button type="submit" class="submit-btn">
                <i class="fas fa-magic"></i>
                Find My Movies
            </button>

            <!-- Clear Filters Button -->
            <button type="button" class="clear-btn" onclick="clearFilters()">
                <i class="fas fa-undo"></i>
                Clear All Filters
            </button>
        </form>

        <!-- Loading Animation -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="color: white; font-size: 1.1rem;">Finding perfect movies for you...</p>
        </div>

        <!-- Results Section -->
        {% if movies %}
        <div class="results-section">
            <div class="results-header">
                <h2><i class="fas fa-magic"></i> Your Perfect Matches</h2>
                <div class="results-info">
                    <p style="color: rgba(255,255,255,0.8);">
                        We found {{ movies|length }} amazing movies just for you!
                    </p>
                    {% if applied_filters %}
                    <div class="applied-filters">
                        <strong>Applied Filters:</strong>
                        {% for filter_name, filter_value in applied_filters.items() %}
                        <span class="filter-tag">
                            <i class="fas fa-tag"></i>
                            {{ filter_name }}: {{ filter_value }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="movies-grid">
                {% for movie in movies %}
                <div class="movie-card">
                    <div class="movie-poster">
                        {% if movie.poster %}
                        <img src="{{ movie.poster }}" alt="{{ movie.title }} Poster" 
                             onerror="this.src='https://via.placeholder.com/300x450/667eea/ffffff?text=' + encodeURIComponent('{{ movie.title }}')">
                        {% else %}
                        <img src="https://via.placeholder.com/300x450/667eea/ffffff?text={{ movie.title|urlencode }}" 
                             alt="{{ movie.title }} Poster">
                        {% endif %}
                        <div class="poster-overlay">
                            <div class="rating-badge-large">
                                <i class="fas fa-star"></i>
                                {{ "%.1f"|format(movie.rating) }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="movie-content">
                        <div class="movie-title">
                            <i class="fas fa-video"></i>
                            {{ movie.title }}
                        </div>
                        
                        <div class="movie-info">
                            <div class="info-item">
                                <i class="fas fa-theater-masks"></i>
                                <span>{{ movie.genre }}</span>
                            </div>
                            
                            <div class="info-item">
                                <i class="fas fa-globe"></i>
                                <span>{{ movie.language }}</span>
                            </div>
                            
                            {% if movie.director %}
                            <div class="info-item">
                                <i class="fas fa-user-tie"></i>
                                <span>{{ movie.director }}</span>
                            </div>
                            {% endif %}
                            
                            {% if movie.num_ratings %}
                            <div class="info-item">
                                <i class="fas fa-heart"></i>
                                <span>{{ movie.num_ratings }} ratings</span>
                            </div>
                            {% endif %}
                            
                            {% if movie.cast %}
                            <div class="cast-info">
                                <i class="fas fa-users"></i>
                                <strong>Cast:</strong> {{ movie.cast }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="feedback-form">
                            <h4><i class="fas fa-thumbs-up"></i> Rate This Movie</h4>
                            <form action="/feedback" method="POST" class="feedback-input-group">
                                <input type="hidden" name="movie_title" value="{{ movie.title }}">
                                <input type="number" step="0.1" name="rating" min="0" max="10" 
                                       placeholder="Your rating (0-10)" required>
                                <button type="submit" class="feedback-btn">
                                    <i class="fas fa-paper-plane"></i>
                                    Submit
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- No Results Message -->
        {% if searched and not movies %}
        <div class="no-results">
            <div class="no-results-content">
                <i class="fas fa-search"></i>
                <h3>No Movies Found</h3>
                <p>Try adjusting your filters or search criteria:</p>
                <ul>
                    <li>Lower the minimum rating</li>
                    <li>Select different genres or languages</li>
                    <li>Try a broader search term</li>
                    <li>Select "All" for genre and language</li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Genre selector functionality
        const genreTabs = document.querySelectorAll('.genre-tab');
        const genreOptions = document.getElementById('genreOptions');
        const selectedGenresInput = document.getElementById('selectedGenres');
        const genreCheckboxes = document.querySelectorAll('input[name="genres"]');
        const genreSearch = document.getElementById('genreSearch');

        genreTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                genreTabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                if (this.dataset.mode === 'select') {
                    genreOptions.style.display = 'block';
                } else {
                    genreOptions.style.display = 'none';
                    selectedGenresInput.value = '';
                    genreCheckboxes.forEach(cb => cb.checked = false);
                }
            });
        });

        // Genre search functionality
        genreSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const genreLabels = document.querySelectorAll('.genre-checkbox');
            
            genreLabels.forEach(label => {
                const genreName = label.dataset.genre;
                if (genreName.includes(searchTerm)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        });

        // Select all / Clear all functionality
        document.querySelector('.select-all-btn').addEventListener('click', function() {
            const visibleCheckboxes = Array.from(genreCheckboxes).filter(cb => 
                cb.closest('.genre-checkbox').style.display !== 'none'
            );
            visibleCheckboxes.forEach(cb => cb.checked = true);
            updateSelectedGenres();
        });

        document.querySelector('.clear-selection-btn').addEventListener('click', function() {
            genreCheckboxes.forEach(cb => cb.checked = false);
            updateSelectedGenres();
        });

        // Update selected genres
        function updateSelectedGenres() {
            const selected = Array.from(genreCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            selectedGenresInput.value = selected.join(',');
        }

        genreCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedGenres);
        });

        // Initialize genre selection state
        document.addEventListener('DOMContentLoaded', function() {
            const selectedGenres = selectedGenresInput.value;
            if (selectedGenres) {
                document.querySelector('.genre-tab[data-mode="select"]').click();
                const genres = selectedGenres.split(',');
                genres.forEach(genre => {
                    const checkbox = document.querySelector(`input[name="genres"][value="${genre}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        });

        // Clear filters function
        function clearFilters() {
            document.getElementById('min_rating').value = 5;
            document.getElementById('result_10').checked = true;
            document.getElementById('search_query').value = '';
            document.getElementById('language').value = '';
            document.querySelector('.genre-tab[data-mode="all"]').click();
            genreCheckboxes.forEach(cb => cb.checked = false);
            selectedGenresInput.value = '';
            genreSearch.value = '';
            
            // Reset genre search
            document.querySelectorAll('.genre-checkbox').forEach(label => {
                label.style.display = 'block';
            });
        }

        // Add loading animation on form submit
        document.querySelector('.search-form').addEventListener('submit', function() {
            document.getElementById('loading').style.display = 'block';
        });

        // Add smooth scroll to results
        if (document.querySelector('.results-section')) {
            setTimeout(() => {
                document.querySelector('.results-section').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
        }

        // Add input animations
        document.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
                this.parentElement.style.transition = 'transform 0.2s ease';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        });

        // Add floating effect to movie cards
        document.querySelectorAll('.movie-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('fadeInUp');
        });

        // Image loading animation
        document.querySelectorAll('.movie-poster img').forEach(img => {
            img.addEventListener('load', function() {
                this.style.opacity = '1';
                this.style.transition = 'opacity 0.3s ease';
            });
        });

        // Rating input validation
        document.getElementById('min_rating').addEventListener('input', function() {
            const value = parseFloat(this.value);
            if (value < 0) this.value = 0;
            if (value > 10) this.value = 10;
        });

        // Search suggestions (basic implementation)
        const searchInput = document.getElementById('search_query');
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length > 2) {
                    this.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1))';
                } else {
                    this.style.background = '';
                }
            }, 300);
        });
    </script>